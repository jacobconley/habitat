version: 2.1
jobs:
  test-end-to-end:
    docker:
      - image: jacobconley/habitat:buster-base@sha256:e88f104cad57728e78db3e3166dc5f63023829a106221531ab3d02ae34081250

    working_directory: /go/src/github.com/jacobconley/habitat/
    steps:
      - run: 
          name: Clear metadata
          command: rm -rf ./* ./.[!.]*
          
      - checkout

      - run: 
          name: Start PostgreSQL
          command: service postgresql start

      - run: 
          name: Set up test fixtures
          command: |
            cd test-fixtures/userland
            yarn install
      
      - run:
          name: Run CLI setup
          command: |
            cd test-fixtures/userland
            go run ../../habitat.go db migrate

      - run: build/test-e2e


workflows:
  regression-testing:
    jobs:
      - test-end-to-end